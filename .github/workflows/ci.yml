name: Validate & Build

on:
  pull_request:
    paths:
      - 'diffs/**/*.json'
      - 'data/schema_diff.json'
      - 'scripts/**'
  push:
    branches: [ main ]
    paths:
      - 'diffs/**/*.json'
      - 'data/schema_diff.json'
      - 'scripts/**'

jobs:
  validate-merge-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install validator deps
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema

      - name: Validate diffs against schema_diff.json
        run: |
          python - <<'PY'
          import json, glob, sys
          from jsonschema import validate, ValidationError

          with open('data/schema_diff.json','r',encoding='utf-8') as f:
            schema = json.load(f)

          ok = True
          for path in sorted(glob.glob('diffs/*.json')):
            try:
              with open(path,'r',encoding='utf-8') as f:
                obj = json.load(f)
              validate(instance=obj, schema=schema)
              print('VALID', path)
            except Exception as e:
              ok = False
              print('INVALID', path, '->', e)
          sys.exit(0 if ok else 1)
          PY

      # Merge & export only when pushing to main
      - name: Merge diffs into MASTER.json
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          shopt -s nullglob
          for D in diffs/*.json; do
            echo "::group::Merging $D"
            python scripts/merge_diff.py data/MASTER.json "$D" "ci"
            echo "::endgroup::"
          done

      - name: Export docs/kyphi_long.json
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          python scripts/export_long.py data/MASTER.json docs/kyphi_long.json

      - name: Commit and push changes
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "CI: merge diffs and rebuild kyphi_long.json"
          branch: main
